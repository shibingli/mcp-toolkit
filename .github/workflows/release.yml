name: Release

on:
  push:
    tags:
      # 只在推送符合 vXX.YY.ZZ 或 vXX.YY.ZZ-CCC 格式的 tag 时触发
      # 例如: v1.0.0, v1.2.3, v2.0.0-alpha, v1.5.0-beta.1
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0, v1.0.0-alpha)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          cache: true

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "### Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Download Go dependencies
        run: go mod download

      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.txt | tail -1 >> $GITHUB_STEP_SUMMARY

      - name: Build for all platforms
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          GOEXPERIMENT: jsonv2,greenteagc
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: Verify build artifacts
        run: |
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Windows Packages (zip)" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/*windows*.zip | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Linux/macOS Packages (tar.gz)" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/*{linux,darwin}*.tar.gz | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Checksums" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat dist/checksums.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          files: |
            dist/*.zip
            dist/*.tar.gz
            dist/checksums.txt
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'alpha') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'rc') }}
          generate_release_notes: true
          body: |
            ## Installation

            ### Using uv (Recommended)
            ```bash
            uv tool install mcp-toolkit
            ```

            ### Using install script

            **Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            Invoke-WebRequest -Uri "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.ps1" -OutFile "install.ps1"
            .\install.ps1
            ```

            ### Manual Download
            Download the appropriate binary for your platform from the assets below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-toolkit-${{ steps.get_version.outputs.VERSION }}
          path: |
            dist/*.zip
            dist/*.tar.gz
            dist/checksums.txt
          retention-days: 90

  # 构建平台特定的 Python wheel 包
  # Build platform-specific Python wheels
  build-python-wheels:
    name: Build Python wheel (${{ matrix.os }}-${{ matrix.arch }})
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            archive_ext: tar.gz
            wheel_tag: manylinux2014_x86_64
          - os: linux
            arch: arm64
            archive_ext: tar.gz
            wheel_tag: manylinux2014_aarch64
          - os: darwin
            arch: amd64
            archive_ext: tar.gz
            wheel_tag: macosx_10_9_x86_64
          - os: darwin
            arch: arm64
            archive_ext: tar.gz
            wheel_tag: macosx_11_0_arm64
          - os: windows
            arch: amd64
            archive_ext: zip
            wheel_tag: win_amd64
          - os: windows
            arch: arm64
            archive_ext: zip
            wheel_tag: win_arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling wheel

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION_TAG="${{ github.event.inputs.version }}"
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION_TAG=${GITHUB_REF#refs/tags/}
          else
            VERSION_TAG=$(git describe --tags --abbrev=0)
          fi
          VERSION=${VERSION_TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_OUTPUT

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: mcp-toolkit-${{ steps.get_version.outputs.VERSION_TAG }}
          path: ./downloads

      - name: Extract binary
        run: |
          mkdir -p python/mcp_toolkit_wrapper/bin
          # 删除 .gitkeep 文件以避免 wheel 中出现重复文件
          # Remove .gitkeep to avoid duplicate files in wheel
          rm -f python/mcp_toolkit_wrapper/bin/.gitkeep

          cd downloads

          ARCHIVE_NAME="mcp-toolkit-${{ steps.get_version.outputs.VERSION_TAG }}-${{ matrix.os }}-${{ matrix.arch }}.${{ matrix.archive_ext }}"

          if [[ "${{ matrix.archive_ext }}" == "zip" ]]; then
            unzip -o "$ARCHIVE_NAME"
          else
            tar -xzf "$ARCHIVE_NAME"
          fi

          # 找到二进制文件并复制 / Find and copy binary
          BINARY_NAME="mcp-toolkit"
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            BINARY_NAME="mcp-toolkit.exe"
          fi

          EXTRACTED_DIR="mcp-toolkit-${{ matrix.os }}-${{ matrix.arch }}"
          cp "${EXTRACTED_DIR}/${BINARY_NAME}" ../python/mcp_toolkit_wrapper/bin/

          echo "Binary copied:"
          ls -la ../python/mcp_toolkit_wrapper/bin/

      - name: Update version in pyproject.toml
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml

      - name: Build wheel
        run: python -m build --wheel

      - name: Rename wheel with platform tag
        run: |
          cd dist
          for f in *.whl; do
            BASENAME=$(echo "$f" | sed 's/-py3-none-any\.whl$//')
            NEW_NAME="${BASENAME}-py3-none-${{ matrix.wheel_tag }}.whl"
            mv "$f" "$NEW_NAME"
            echo "Renamed: $f -> $NEW_NAME"
          done
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*.whl
          retention-days: 90

  # 构建源码分发包 / Build source distribution
  build-python-sdist:
    name: Build Python sdist
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            VERSION=${VERSION#v}
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(git describe --tags --always --dirty | sed 's/^v//')
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 90

  # 发布到 PyPI / Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    needs: [ build, build-python-wheels, build-python-sdist ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''
    environment:
      name: pypi
      url: https://pypi.org/project/mcp-sandbox-toolkit/

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-wheel-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: dist

      - name: List distributions
        run: |
          echo "Distributions to publish:"
          ls -la dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install twine
        run: pip install twine

      - name: Check packages
        run: python -m twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload dist/* --verbose
          echo "✅ Published to PyPI" >> $GITHUB_STEP_SUMMARY

      - name: Create summary
        run: |
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Packages:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install: \`pip install mcp-sandbox-toolkit\`" >> $GITHUB_STEP_SUMMARY
          echo "or: \`uv tool install mcp-sandbox-toolkit\`" >> $GITHUB_STEP_SUMMARY
          echo "or: \`pipx install mcp-sandbox-toolkit\`" >> $GITHUB_STEP_SUMMARY

